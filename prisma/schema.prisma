generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_DIRECT")
}

/// Category - System managed, not auto-created from Notion
model Category {
  id             String    @id @default(uuid())
  slug           String    @unique
  name           String
  description    String?
  ctaTitle       String?
  ctaDescription String?
  ctaButtonText  String?
  ctaButtonUrl   String?
  order          Int       @default(0)
  isActive       Boolean   @default(true)
  noIndex        Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  contents       Content[]

  @@index([isActive, order])
}

/// Content - Blog posts, pages, courses synced from Notion or created manually
model Content {
  id                 String         @id @default(uuid())
  type               ContentType    @default(BLOG)
  title              String
  slug               String         @unique
  summary            String?
  contentMd          String
  contentHtml        String?
  coverImageId       String?
  status             ContentStatus  @default(DRAFT)
  visibility         Visibility     @default(PUBLIC)
  publishedAt        DateTime?
  notionPageId       String?        @unique
  notionLastEditedAt DateTime?
  source             ContentSource  @default(NOTION)
  categoryId         String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  readingTime        Int?
  category           Category?      @relation(fields: [categoryId], references: [id])
  coverImage         Media?         @relation("ContentCover", fields: [coverImageId], references: [id])
  previewTokens      PreviewToken[]
  seo                SeoMeta?

  @@index([status, visibility, publishedAt(sort: Desc)])
  @@index([categoryId, status])
  @@index([type, status])
}

/// SeoMeta - SEO metadata for content, managed separately from Notion
model SeoMeta {
  id              String    @id @default(uuid())
  contentId       String    @unique
  metaTitle       String?
  metaDescription String?
  ogImageId       String?
  canonicalUrl    String?
  noIndex         Boolean   @default(false)
  geoAuditedAt    DateTime?
  geoScore        Int?
  keywords        String[]  @default([])
  schemaJson      String?
  snippetLinkedIn String?
  snippetReddit   String?
  snippetTwitter  String?
  suggestedLinks  String[]  @default([])
  content         Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  ogImage         Media?    @relation("SeoOgImage", fields: [ogImageId], references: [id])

  @@index([geoScore])
}

/// Media - Images and files stored in Supabase Storage
model Media {
  id            String    @id @default(uuid())
  filename      String
  originalUrl   String?
  storageUrl    String
  storagePath   String
  mimeType      String
  size          Int
  width         Int?
  height        Int?
  notionBlockId String?   @unique
  createdAt     DateTime  @default(now())
  contentCovers Content[] @relation("ContentCover")
  seoOgImages   SeoMeta[] @relation("SeoOgImage")

  @@index([notionBlockId])
}

/// PreviewToken - Temporary tokens for previewing unpublished content
model PreviewToken {
  id        String   @id @default(uuid())
  token     String   @unique
  contentId String
  expiresAt DateTime
  createdAt DateTime @default(now())
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
}

/// User - Admin and editor users for the backend
model User {
  id            String              @id @default(uuid())
  email         String              @unique
  name          String?
  role          UserRole            @default(USER)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  emailVerified Boolean             @default(false)
  image         String?
  credits       Int                 @default(0)
  accounts      Account[]
  transactions  CreditTransaction[]
  sessions      Session[]
  executions    SkillExecution[]
  trackedArticles TrackedArticle[]

  @@index([email])
}

/// TrackedArticle - Closed-loop verification for GEO citations
model TrackedArticle {
  id               String    @id @default(uuid())
  userId           String
  title            String
  url              String?
  keywords         String[]
  optimizedContent String
  status           String    @default("PENDING") // PENDING, CHECKING, CITED, NOT_CITED
  lastCheckedAt    DateTime?
  citationSource   String? // e.g. "Perplexity", "Gemini"
  checkCount       Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  updatedAt DateTime @updatedAt
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

/// SyncLog - Track Notion sync operations
model SyncLog {
  id          String    @id @default(uuid())
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  status      String
  itemsTotal  Int       @default(0)
  itemsSynced Int       @default(0)
  itemsFailed Int       @default(0)
  error       String?

  @@index([startedAt(sort: Desc)])
}

/// CreditTransaction - Track all credit-related activities
model CreditTransaction {
  id             String          @id @default(uuid())
  userId         String
  amount         Int
  type           TransactionType
  description    String?
  createdAt      DateTime        @default(now())
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  skillExecution SkillExecution?

  @@index([userId])
  @@index([createdAt(sort: Desc)])
}

/// SkillExecution - Detailed logs of AI tool usage
model SkillExecution {
  id              String             @id @default(uuid())
  skillName       String
  status          String             @default("success")
  input           Json
  output          Json?
  metadata        Json?
  cost            Float?
  executionTimeMs Int?
  errorMessage    String?
  createdAt       DateTime           @default(now())
  modelUsed       String?
  provider        String?
  tokensUsed      Int?
  transactionId   String?            @unique
  userId          String?
  transaction     CreditTransaction? @relation(fields: [transactionId], references: [id])
  user            User?              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([skillName])
  @@index([createdAt(sort: Desc)])
}

enum ContentType {
  BLOG
  PAGE
  COURSE
}

enum ContentStatus {
  DRAFT
  SYNCED
  PUBLISHED
  ARCHIVED
}

enum Visibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

enum ContentSource {
  NOTION
  MANUAL
}

enum UserRole {
  ADMIN
  EDITOR
  USER
}

enum TransactionType {
  PURCHASE
  CONSUMPTION
  REFUND
  BONUS
}

/// SkillConfig - Dynamic configuration for AI tools
model SkillConfig {
  id          String   @id @default(uuid())
  name        String   @unique // e.g. "GEO_WRITER_FULL"
  displayName String   // e.g. "Geo Writer (Full)"
  description String?
  cost        Int      @default(0)
  isActive    Boolean  @default(true) // Global kill switch
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}
