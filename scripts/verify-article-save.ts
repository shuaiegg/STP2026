import prisma from "../src/lib/prisma";

/**
 * éªŒè¯æ–‡ç« ä¿å­˜é€»è¾‘çš„æ ¸å¿ƒæœåŠ¡å‡½æ•° (æ¨¡æ‹Ÿ Server Action)
 */
async function saveArticleInternal(data: {
    userId: string;
    title: string;
    summary?: string;
    keywords: string[];
    optimizedContent: string;
    contentHtml?: string;
}) {
    return await prisma.trackedArticle.create({
        data: {
            userId: data.userId,
            title: data.title,
            summary: data.summary,
            keywords: data.keywords,
            optimizedContent: data.optimizedContent,
            contentHtml: data.contentHtml,
            status: "PENDING",
        },
    });
}

async function verifyArticleSave() {
    console.log("ğŸ” [QA] Starting Article Persistence Verification...");

    try {
        // 1. è·å–æµ‹è¯•ç”¨æˆ· (æ°å…‹)
        const user = await prisma.user.findFirst({
            where: { email: "jack47.chn@gmail.com" }
        });

        if (!user) {
            throw new Error("Test user not found. Please run verify-auth.ts first.");
        }
        console.log(`âœ… [User] Using user: ${user.email} (${user.id})`);

        // 2. æ¨¡æ‹Ÿä¿å­˜ä¸€ç¯‡æ–‡ç« 
        const testArticle = {
            userId: user.id,
            title: "Test AI Article " + new Date().getTime(),
            summary: "This is a test summary for SEO.",
            keywords: ["SEO", "AI Writing", "STP"],
            optimizedContent: "## Hello World\nThis is the content generated by Aladdin.",
            contentHtml: "<h2>Hello World</h2><p>This is the content generated by Aladdin.</p>"
        };

        console.log("ğŸš€ [Action] Saving article to database...");
        const saved = await saveArticleInternal(testArticle);
        
        console.log(`âœ… [DB] Article saved successfully. ID: ${saved.id}`);

        // 3. éªŒè¯æ•°æ®ä¸€è‡´æ€§
        const fetched = await prisma.trackedArticle.findUnique({
            where: { id: saved.id }
        });

        if (fetched?.title === testArticle.title && fetched?.summary === testArticle.summary) {
            console.log("âœ… [Data] Consistency check passed.");
        } else {
            throw new Error("Data consistency check failed!");
        }

        // 4. æ¸…ç†æµ‹è¯•æ•°æ® (å¯é€‰ï¼Œä½†ä¸ºäº†ä¿æŒæ•°æ®åº“æ•´æ´å»ºè®®æ‰§è¡Œ)
        await prisma.trackedArticle.delete({ where: { id: saved.id } });
        console.log("ğŸ§¹ [Cleanup] Test data removed.");

        console.log("\nâœ¨ [QA] Article Persistence Verification PASSED.");
    } catch (error) {
        console.error("\nâŒ [QA] Verification FAILED:");
        console.error(error);
        process.exit(1);
    }
}

verifyArticleSave();
